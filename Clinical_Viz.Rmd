---
title: "Clinical Visualization"
author: "Daniel Olofin"
date: "2025-09-25"
output:
  pdf_document:
    latex_engine: xelatex
always_allow_html: true
fontsize: 11pt
geometry: margin=0.5in
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Aim

The aim of this project is to develop a visualization gallery that demonstrates the power of data visualization in summarizing and interpreting clinical trial data. Using the colon dataset from the survival R package, the project seeks to highlight how different visualization techniques can uncover patterns, communicate trial results, and support evidence-based decision-making in oncology research.

## Objectives

1. Showcase diverse visualization methods:
Implement at least 10 different plots, including survival curves, subgroup analyses, and exploratory graphics, to present the colon dataset from multiple perspectives.

2. Communicate clinical insights effectively:
Use plots to explain treatment effects, recurrence and survival patterns, and relationships between demographic, clinical, and outcome variables.

3. Bridge statistics and storytelling:
Translate statistical outputs (e.g., hazard ratios, cumulative incidence, survival probabilities) into intuitive graphics that can be understood by both technical and non-technical audiences.

4. Highlight best practices in reproducibility:
Use R (ggplot2, survminer, etc.) to build reproducible visualization pipelines for clinical trial data analysis.

5. Create a portfolio-ready deliverable:
Assemble the collection into a cohesive visualization gallery (markdown/Quarto notebook or GitHub repo) to serve as a demonstration of technical, statistical, and communication skills.


# liberies 
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(survival)
library(survminer)
library(plotly)
library(broom)
library(dplyr)
library(meta)
library(tidyverse)
library(patchwork)
library(gridExtra)

```
## Loading of Data
```{r echo=FALSE, message=FALSE, warning=FALSE}
# replace path with your dataset location
mydata <- survival::colon
```

### Data Cleaning and Restructing 
```{r echo=FALSE, message=FALSE, warning=FALSE}
new_data<-mydata %>% 
  mutate(
    sex = ifelse(sex == 1, "Male", "Female"),
    obstruct = ifelse(obstruct == 0, "No obstruction", "Obstruction present"),
    perfor = ifelse(perfor == 0, "No", "Yes"),
    adhere = ifelse(adhere == 0, "No", "Yes"),
    status = ifelse(status == 0, "Censored",
             ifelse(status == 1, "Recurrence", "Death")),
    differ = ifelse(differ == 1, "Well-differentiated",
             ifelse(differ == 2, "Moderately differentiated", "Poorly differentiated")),
    extent = ifelse(extent == 1, "Submucosa",
             ifelse(extent == 2, "Muscle",
             ifelse(extent == 3, "Serosa", "Contiguous structures"))),
    surg = ifelse(surg == 0, "Short (<8 weeks)", "Long (≥8 weeks)"),
    node4 = ifelse(node4 == 0, "< 4 nodes", "≥ 4 nodes"),
    etype = ifelse(etype == 1, "Recurrence", "Death")
  )


# Creating a Data Dictionary

# Relabel dictionary for colon dataset
var_labels <- c(
  id       = "Patient ID",
  study    = "Study ID",
  rx       = "Treatment Group",
  sex      = "Sex (0=Female, 1=Male)",
  age      = "Age (years)",
  obstruct = "Colon Obstruction (Yes/No)",
  perfor   = "Colon Perforation (Yes/No)",
  adhere   = "Tumor Adherence (Yes/No)",
  nodes    = "Positive Lymph Nodes",
  status   = "Event Status (0=Censored, 1=Recurrence, 2=Death)",
  differ   = "Tumor Differentiation (1=Well, 2=Moderate, 3=Poor)",
  extent   = "Extent of Spread (1=Submucosa, 4=Contiguous)",
  surg     = "Surgery to Registration (0=<8wks, 1=≥8wks)",
  node4    = "≥4 Positive Lymph Nodes (Yes/No)",
  time     = "Follow-up Time (days)",
  etype    = "Event Type (1=Recurrence, 2=Death)"
)
```


### Visualization Gallery Plan


#### Descriptive / Baseline Characteristics

```{r echo=FALSE, message=FALSE, warning=FALSE, out.width="100%", fig.align='center', fig.width= 12, fig.height= 6, out.width="100%"}
new_data %>% 
  group_by(sex,rx) %>% 
  summarise(n = n()) %>% 
    mutate(percentage =100*(n/sum(n))) %>% 
  arrange(percentage) %>%
  ungroup() %>% 
ggplot(aes(x = rx, y = percentage)) +
  geom_bar(aes(fill = sex), stat = "identity",position = "dodge") +
    scale_fill_brewer(palette = "PuBu")+
  labs(y = "Percentage", x = "Treatment", fill = "Sex", 
       title = "Sex-Based Differences in Treatment Allocation", subtitle = "Percentage breakdown of each treatment group across male and female patients") +
  geom_text(aes(y = percentage, x = rx, fill = sex,
 label = paste0(round(percentage,2),"%")), position = position_dodge(width = 0.9), vjust = -0.2)+
  theme_minimal() -> viz_1



new_data %>% 
  group_by(sex, rx) %>% 
  summarise(n = n()) %>% 
  mutate(percentage = 100 * (n / sum(n))) %>% 
  ungroup() %>%
  ggplot(aes(x = rx, y = percentage, fill = rx)) +
  geom_bar(stat = "identity", show.legend = F) +
  facet_wrap(~sex) +
  scale_fill_brewer(palette = "PuBu") +
  labs(
    title = "Distribution of Treatments by Sex",
    subtitle = "Faceted view showing treatment percentage per sex",
    x = "Treatment", y = "Percentage"
  ) +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), vjust = -0.3) +
  theme_minimal() -> viz_2


viz_1|viz_2
```

#### Survival & Prognostic Analysis

```{r echo=FALSE, fig.align='center', fig.height=10, fig.width=7, message=FALSE, warning=FALSE, out.width="60%"}
cox_fit <- coxph(Surv(time, status) ~ rx + age + nodes + extent, data = mydata)

# Enhanced ggforest
ggforest(cox_fit, 
         data = mydata,
         main = "Hazard Ratios for Colon Cancer Survival",
         cpositions = c(0.02, 0.22, 0.4),
         fontsize = 1.0,
         refLabel = "Reference",
         noDigits = 2)
```

#### 1. Kaplan-Meier Curve Treatment & Subgroup Comparison

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6, fig.align='center', out.width="100%"}
fit_1 <- survfit(Surv(time,status) ~ sex, data = mydata)


surv1 <-ggsurvplot(fit_1,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          tables.height = 0.05,
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Male","Female"))

fit_2 <- survfit(Surv(time, status) ~ rx, data = mydata)

surv2 <-ggsurvplot(fit_2,
          pval = T, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          tables.height = 0.05,
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF", "red")) 


plot1 <- surv1$plot / surv1$table + plot_layout(heights = c(4, 1))
plot2 <- surv2$plot / surv2$table + plot_layout(heights = c(4, 1))

(plot1 | plot2) +
  plot_annotation(title = "Kaplan-Meier Curves with Compact Risk Tables")

```

#### Cumulative Incidence Curve

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6, fig.align='center', out.width="100%"}
c_plot_1<-ggsurvplot(fit_1, 
           data = mydata, 
           fun = "event", 
           censor = FALSE,
           pval = TRUE,    # set to FALSE if don't want p-value
           pval.coord = c(270, 0.05),  # can delete this line if don't want p-value
           risk.table = TRUE, 
           legend.title = "Popn", 
           legend.labs = c("Male", "Female"),
           palette = c("#E7B800", "#2E9FDF"), 
           break.time.by = 300, 
           xlab = "Days from Initial Visit", 
           ylab = "Cumulative Incidence of Follow-up",
           axes.offset = TRUE,
           ylim = c(0, 1),
           tables.theme = theme_void(),
           tables.height = 0.15,
           tables.col = "strata",
           surv.scale = "percent")


c_plot_2 <- ggsurvplot(fit_2, 
           data = mydata, 
           fun = "event", 
           censor = FALSE,
           pval = TRUE,    # set to FALSE if don't want p-value
           pval.coord = c(270, 0.05),  # can delete this line if don't want p-value
           risk.table = TRUE, 
           legend.title = "Popn",
           palette = c("#E7B800", "#2E9FDF", "red"), 
           break.time.by = 300, 
           xlab = "Days from Initial Visit", 
           ylab = "Cumulative Incidence of Follow-up",
           axes.offset = TRUE,
           ylim = c(0, 1),
           tables.theme = theme_void(),
           tables.height = 0.15,
           tables.col = "strata",
           surv.scale = "percent")

plot1 <- c_plot_1$plot / c_plot_1$table + plot_layout(heights = c(4, 1))
plot2 <- c_plot_2$plot / c_plot_2$table + plot_layout(heights = c(4, 1))

(plot1 | plot2) +
  plot_annotation(title = "Kaplan-Meier Curves with Compact Risk Tables")

```



```{r echo=FALSE, fig.align='center', fig.height=6, fig.width=12, message=FALSE, warning=FALSE, out.width="100%"}

# Tidy and sort by absolute effect size
tidy_cox <- tidy(cox_fit, exponentiate = FALSE, conf.int = TRUE) %>%
  filter(term != "(Intercept)")  # Remove intercept if present

# Plot
ggplot(tidy_cox, aes(x = reorder(term, abs(estimate)), y = estimate)) +
  geom_segment(aes(xend = term, y = 0, yend = estimate), color = "grey60") +
  geom_point(size = 4, color = "steelblue") +
  coord_flip() +
  labs(
    title = "Variable Importance from Cox Model",
    subtitle = "Based on absolute magnitude of regression coefficients",
    x = "Variable", y = "Coefficient Estimate (log HR)"
  ) +
  theme_minimal()

```

