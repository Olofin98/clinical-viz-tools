---
title: "Clinical Visualization"
author: "Daniel Olofin"
date: "2025-09-25"
output:
  pdf_document:
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Aim

The aim of this project is to develop a visualization gallery that demonstrates the power of data visualization in summarizing and interpreting clinical trial data. Using the colon dataset from the survival R package, the project seeks to highlight how different visualization techniques can uncover patterns, communicate trial results, and support evidence-based decision-making in oncology research.

## Objectives

1. Showcase diverse visualization methods:
Implement at least 10 different plots, including survival curves, subgroup analyses, and exploratory graphics, to present the colon dataset from multiple perspectives.

2. Communicate clinical insights effectively:
Use plots to explain treatment effects, recurrence and survival patterns, and relationships between demographic, clinical, and outcome variables.

3. Bridge statistics and storytelling:
Translate statistical outputs (e.g., hazard ratios, cumulative incidence, survival probabilities) into intuitive graphics that can be understood by both technical and non-technical audiences.

4. Highlight best practices in reproducibility:
Use R (ggplot2, survminer, etc.) to build reproducible visualization pipelines for clinical trial data analysis.

5. Create a portfolio-ready deliverable:
Assemble the collection into a cohesive visualization gallery (markdown/Quarto notebook or GitHub repo) to serve as a demonstration of technical, statistical, and communication skills.


# liberies 
```{r echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(survival)
library(survminer)
library(plotly)
library(broom)
library(dplyr)

```
## Loading of Data
```{r echo=FALSE, message=FALSE, warning=FALSE}
# replace path with your dataset location
mydata <- survival::colon
```

### Data Cleaning and Restructing 
```{r}
new_data<-mydata %>% 
  mutate(
    sex = ifelse(sex == 1, "Male", "Female"),
    obstruct = ifelse(obstruct == 0, "No obstruction", "Obstruction present"),
    perfor = ifelse(perfor == 0, "No", "Yes"),
    adhere = ifelse(adhere == 0, "No", "Yes"),
    status = ifelse(status == 0, "Censored",
             ifelse(status == 1, "Recurrence", "Death")),
    differ = ifelse(differ == 1, "Well-differentiated",
             ifelse(differ == 2, "Moderately differentiated", "Poorly differentiated")),
    extent = ifelse(extent == 1, "Submucosa",
             ifelse(extent == 2, "Muscle",
             ifelse(extent == 3, "Serosa", "Contiguous structures"))),
    surg = ifelse(surg == 0, "Short (<8 weeks)", "Long (≥8 weeks)"),
    node4 = ifelse(node4 == 0, "< 4 nodes", "≥ 4 nodes"),
    etype = ifelse(etype == 1, "Recurrence", "Death")
  )


# Creating a Data Dictionary

# Relabel dictionary for colon dataset
var_labels <- c(
  id       = "Patient ID",
  study    = "Study ID",
  rx       = "Treatment Group",
  sex      = "Sex (0=Female, 1=Male)",
  age      = "Age (years)",
  obstruct = "Colon Obstruction (Yes/No)",
  perfor   = "Colon Perforation (Yes/No)",
  adhere   = "Tumor Adherence (Yes/No)",
  nodes    = "Positive Lymph Nodes",
  status   = "Event Status (0=Censored, 1=Recurrence, 2=Death)",
  differ   = "Tumor Differentiation (1=Well, 2=Moderate, 3=Poor)",
  extent   = "Extent of Spread (1=Submucosa, 4=Contiguous)",
  surg     = "Surgery to Registration (0=<8wks, 1=≥8wks)",
  node4    = "≥4 Positive Lymph Nodes (Yes/No)",
  time     = "Follow-up Time (days)",
  etype    = "Event Type (1=Recurrence, 2=Death)"
)
```


### Visualization Gallery Plan

#### 1. Kaplan-Meier Curve

```{r}
fit_1 <- survfit(Surv(time,status) ~ sex, data = mydata)


ggsurvplot(fit_1,
          pval = TRUE, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF"),
          legend.labs = c("Male","Female"))

fit_2 <- survfit(Surv(time, status) ~ rx, data = mydata)

ggsurvplot(fit_2,
          pval = F, conf.int = TRUE,
          risk.table = TRUE, # Add risk table
          risk.table.col = "strata", # Change risk table color by groups
          linetype = "strata", # Change line type by groups
          surv.median.line = "hv", # Specify median survival
          ggtheme = theme_bw(), # Change ggplot2 theme
          palette = c("#E7B800", "#2E9FDF", "red")) 

```

#### Cumulative Incidence Curve

```{r fig.width=12, fig.height=8}
ggsurvplot(fit_1, 
           data = mydata, 
           fun = "event", 
           censor = FALSE,
           pval = TRUE,    # set to FALSE if don't want p-value
           pval.coord = c(270, 0.05),  # can delete this line if don't want p-value
           risk.table = TRUE, 
           legend.title = "Popn", 
           legend.labs = c("Male", "Female"),
           palette = c("#E7B800", "#2E9FDF"), 
           break.time.by = 300, 
           xlab = "Days from Initial Visit", 
           ylab = "Cumulative Incidence of Follow-up",
           axes.offset = TRUE,
           ylim = c(0, 1),
           tables.theme = theme_void(),
           tables.height = 0.15,
           tables.col = "strata",
           surv.scale = "percent")


ggsurvplot(fit_2, 
           data = mydata, 
           fun = "event", 
           censor = FALSE,
           pval = TRUE,    # set to FALSE if don't want p-value
           pval.coord = c(270, 0.05),  # can delete this line if don't want p-value
           risk.table = TRUE, 
           legend.title = "Popn",
           palette = c("#E7B800", "#2E9FDF", "red"), 
           break.time.by = 300, 
           xlab = "Days from Initial Visit", 
           ylab = "Cumulative Incidence of Follow-up",
           axes.offset = TRUE,
           ylim = c(0, 1),
           tables.theme = theme_void(),
           tables.height = 0.15,
           tables.col = "strata",
           surv.scale = "percent")
```


#### Forest Plot (Subgroup Analysis)

```{r}
new_data$age_group <- ifelse(mydata$age < 60, "<60", "60 and above")

new_data_1 <- new_data %>% 
                    select(sex, age_group, extent, rx, status, time,etype) %>% 
                    mutate(status = ifelse(status == "Censored", 0,
                                           ifelse(status == "Recurrence", 1, 2)))

## By Sex - Male
new_data_1_male <- new_data_1 %>% 
                        filter(sex == "Male")

cox_male <- coxph(Surv(time,etype == 2)~ rx, data = new_data_1_male)
tidy_male <- tidy(cox_male, exponentiate = TRUE, conf.int = TRUE)
tidy_male$subgroup <- "Sex = Male"   


## By Sex - Female
new_data_1_female <- new_data_1 %>% 
                        filter(sex == "Female")

cox_female <- coxph(Surv(time,etype == 2)~ rx, data = new_data_1_female)
tidy_female <- tidy(cox_male, exponentiate = TRUE, conf.int = TRUE)
tidy_female$subgroup <- "Sex = Female"   



```

